#!/bin/bash
PROJECT_ID=$1
echo $PROJECT_ID
export PROJECT_ID=$PROJECT_ID
REGION=$2
echo $REGION
gcloud config set project $PROJECT_ID
gsutil mb -p $PROJECT_ID -l $REGION -b on gs://$PROJECT_ID-terraform-state
gcloud services enable iamcredentials.googleapis.com
gcloud services enable cloudresourcemanager.googleapis.com

gcloud iam service-accounts create terraform-sa --display-name="Terraform SA"
export GOOGLE_IMPERSONATE_SERVICE_ACCOUNT=terraform-sa@$PROJECT_ID.iam.gserviceaccount.com

gcloud projects add-iam-policy-binding $PROJECT_ID \
    --member=serviceAccount:terraform-sa@$PROJECT_ID.iam.gserviceaccount.com \
    --role=roles/storage.objectUser

gcloud projects add-iam-policy-binding $PROJECT_ID \
    --member=serviceAccount:terraform-sa@$PROJECT_ID.iam.gserviceaccount.com \
    --role=roles/serviceusage.serviceUsageAdmin

gcloud projects add-iam-policy-binding $PROJECT_ID \
    --member=serviceAccount:terraform-sa@$PROJECT_ID.iam.gserviceaccount.com \
    --role=roles/compute.networkAdmin

gcloud projects add-iam-policy-binding $PROJECT_ID \
    --member=serviceAccount:terraform-sa@$PROJECT_ID.iam.gserviceaccount.com \
    --role=roles/vmwareengine.vmwareengineAdmin


terraform init -backend-config="bucket=$PROJECT_ID-terraform-state"

terraform plan -var 'project_id=$PROJECT_ID' -out=plan.out

terraform apply plan.out -var 'project_id=$PROJECT_ID' -auto-approve


